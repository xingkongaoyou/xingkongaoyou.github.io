"use strict";var ge1doot=ge1doot||{};ge1doot.transform3D={},ge1doot.transform3D.drawPoly=function(){this.ctx.beginPath(),this.ctx.moveTo(this.points[0].X,this.points[0].Y),this.ctx.lineTo(this.points[1].X,this.points[1].Y),this.ctx.lineTo(this.points[2].X,this.points[2].Y),this.ctx.lineTo(this.points[3].X,this.points[3].Y),this.ctx.closePath()},ge1doot.transform3D.Camera=function(t,s){ge1doot.camera=this,this.x=0,this.y=0,this.z=0,this.rx=0,this.ry=0,this.rz=0,this.focalLength=t.focalLength||500,this.easeTranslation=t.easeTranslation||.1,this.easeRotation=t.easeRotation||.025,this.enableRx=!t.disableRx,this.enableRy=!t.disableRy,this.enableRz=!t.disableRz,this.cmov=!1,this.cosX=1,this.sinX=0,this.cosY=1,this.sinY=0,this.cosZ=1,this.sinZ=0,this.target={over:!1,elem:!1,x:0,y:0,z:0,rx:0,ry:0,rz:0},s&&s.move&&(this.cmov=s.move)},ge1doot.transform3D.Camera.prototype.ease=function(t,s){for(;Math.abs(t-s)>Math.PI;)t<s?s-=2*Math.PI:s+=2*Math.PI;return(t-s)*this.easeRotation},ge1doot.transform3D.Camera.prototype.move=function(){this.cmov&&this.cmov(),this.x+=(this.target.x-this.x)*this.easeTranslation,this.y+=(this.target.y-this.y)*this.easeTranslation,this.z+=(this.target.z-this.z)*this.easeTranslation,this.enableRx&&(this.rx+=this.ease(this.target.rx,this.rx),this.cosX=Math.cos(this.rx),this.sinX=Math.sin(this.rx)),this.enableRy&&(this.ry+=this.ease(this.target.ry,this.ry),this.cosY=Math.cos(this.ry),this.sinY=Math.sin(this.ry)),this.enableRz&&(this.rz+=this.ease(this.target.rz,this.rz),this.cosZ=Math.cos(this.rz),this.sinZ=Math.sin(this.rz))},ge1doot.transform3D.Point=function(t,s,i,h,e){this.x=t,this.y=s,this.z=i,this.tx=h||0,this.ty=e||0,this.visible=!1,this.scale=0,this.X=0,this.Y=0,this.Z=0,this.next=!0},ge1doot.transform3D.Point.prototype.projection=function(){var t=this.scr.width>>1,s=this.scr.height>>1,i=this.x-this.camera.x,h=this.y-this.camera.y,e=this.z-this.camera.z;if(this.camera.enableRz)var o=this.camera.sinZ*h+this.camera.cosZ*i,a=this.camera.cosZ*h-this.camera.sinZ*i;else var o=i,a=h;var r=this.camera.cosY*e+this.camera.sinY*o;return this.Z=this.camera.cosX*r-this.camera.sinX*a,this.scale=this.camera.focalLength/Math.max(1,this.Z),this.X=t+(this.camera.cosY*o-this.camera.sinY*e)*this.scale,this.Y=-(this.camera.y>>1)+s-(this.camera.sinX*r+this.camera.cosX*a)*this.scale,this.visible=this.X>.5*-t&&this.X<2.5*t&&this.Y>.5*-s&&this.Y<2.5*s,this.next},ge1doot.transform3D.Triangle=function(t,s,i,h){this.ctx=t.ctx,this.texture=t.texture,this.p0=s,this.p1=i,this.p2=h,this.d=s.tx*(h.ty-i.ty)-i.tx*h.ty+h.tx*i.ty+(i.tx-h.tx)*s.ty,this.pmy=i.ty-h.ty,this.pmx=i.tx-h.tx,this.pxy=h.tx*i.ty-i.tx*h.ty,t.t&&(t.t.next=!0)},ge1doot.transform3D.Triangle.prototype.draw=function(){if(this.p0.visible||this.p1.visible||this.p2.visible){var t,s,i,h=(this.p0.X+this.p1.X+this.p2.X)/3,e=(this.p0.Y+this.p1.Y+this.p2.Y)/3;this.ctx.save(),this.ctx.beginPath(),t=h-this.p0.X,s=e-this.p0.Y,i=Math.max(Math.abs(t),Math.abs(s)),this.ctx.moveTo(this.p0.X-t/i*2,this.p0.Y-s/i*2),t=h-this.p1.X,s=e-this.p1.Y,i=Math.max(Math.abs(t),Math.abs(s)),this.ctx.lineTo(this.p1.X-t/i*2,this.p1.Y-s/i*2),t=h-this.p2.X,s=e-this.p2.Y,i=Math.max(Math.abs(t),Math.abs(s)),this.ctx.lineTo(this.p2.X-t/i*2,this.p2.Y-s/i*2),this.ctx.closePath(),this.ctx.clip();var o=this.p2.X-this.p1.X,a=this.p1.Y-this.p2.Y,r=this.p2.ty*this.p1.X,n=this.p1.tx*this.p2.X,p=this.p2.ty*this.p1.Y,c=this.p1.ty*this.p2.X,x=this.p1.ty*this.p2.Y,g=this.p2.tx*this.p1.X,m=this.p1.tx*this.p2.Y,l=this.p2.tx*this.p1.Y;this.ctx.transform(-(this.p0.ty*o-c+r+this.pmy*this.p0.X)/this.d,(x+this.p0.ty*a-p-this.pmy*this.p0.Y)/this.d,(this.p0.tx*o-n+g+this.pmx*this.p0.X)/this.d,-(m+this.p0.tx*a-l-this.pmx*this.p0.Y)/this.d,(this.p0.tx*(r-c)+this.p0.ty*(n-g)+this.pxy*this.p0.X)/this.d,(this.p0.tx*(p-x)+this.p0.ty*(m-l)+this.pxy*this.p0.Y)/this.d),this.ctx.drawImage(this.texture,0,0),this.ctx.restore()}return this.next},ge1doot.transform3D.Image=function(t,s,i,h){this.parent=t,this.points=[],this.triangles=[],this.ctx=ge1doot.screen.ctx,this.pointer=ge1doot.pointer,this.texture=new Image,this.texture.src=s,this.isLoading=!0,this.callback=h,this.textureWidth=0,this.textureHeight=0,this.level=i||1,this.visible=!1,this.t=!1,ge1doot.transform3D.Point.prototype.scr||(ge1doot.transform3D.Point.prototype.scr=ge1doot.screen,ge1doot.transform3D.Point.prototype.camera=ge1doot.camera)},ge1doot.transform3D.Image.prototype.drawPoly=ge1doot.transform3D.drawPoly,ge1doot.transform3D.Image.prototype.setLevel=function(t){this.points.length=0,this.triangles.length=0,this.level=t,this.loading()},ge1doot.transform3D.Image.prototype.loading=function(){if(this.texture.complete){var t=[0,1,1,0,0,0,1,1];this.isLoading=!1,this.textureWidth=this.texture.width,this.textureHeight=this.texture.height,this.callback&&this.callback.isLoaded&&this.callback.isLoaded(this);for(var s,i=-1;s=this.points[++i];)s.tx=this.textureWidth*t[i],s.ty=this.textureHeight*t[i+4];this.triangulate(this.points[0],this.points[1],this.points[2],this.level),this.triangulate(this.points[0],this.points[2],this.points[3],this.level),this.points[this.points.length-1].next=!1}},ge1doot.transform3D.Image.prototype.subdivise=function(t,s){return{x:.5*(s.x+t.x),y:.5*(s.y+t.y),z:.5*(s.z+t.z),tx:.5*(s.tx+t.tx),ty:.5*(s.ty+t.ty)}},ge1doot.transform3D.Image.prototype.triangulate=function(t,s,i,h){if(0==--h)this.t=new ge1doot.transform3D.Triangle(this,t,s,i),this.triangles.push(this.t);else{var e=this.subdivise(t,s),o=this.subdivise(s,i),a=this.subdivise(i,t);this.points.push(e=new ge1doot.transform3D.Point(e.x,e.y,e.z,e.tx,e.ty)),this.points.push(o=new ge1doot.transform3D.Point(o.x,o.y,o.z,o.tx,o.ty)),this.points.push(a=new ge1doot.transform3D.Point(a.x,a.y,a.z,a.tx,a.ty)),this.triangulate(t,e,a,h),this.triangulate(e,s,o,h),this.triangulate(a,o,i,h),this.triangulate(e,o,a,h)}},ge1doot.transform3D.Image.prototype.transform3D=function(t){if(this.isLoading)return this.loading(),!1;for(var s=0;this.points[s++].projection(););if(t){var i=this.points[0],h=this.points[1],e=this.points[2];return(h.Y-i.Y)/(h.X-i.X)-(e.Y-i.Y)/(e.X-i.X)<0^i.X<=h.X==i.X>e.X}return!0},ge1doot.transform3D.Image.prototype.draw=function(){if(!this.isLoading)for(var t=0;this.triangles[t++].draw(););},ge1doot.transform3D.Image.prototype.isPointerInside=function(t,s){return this.drawPoly(this.points),this.ctx.isPointInPath(t,s)};